# 動画機能 要件定義

## 概要
ブログHTMLを見出し毎に分割し、音声・画像・字幕を組み合わせてMP4動画を生成する機能

---

## 処理フロー（パイプライン）

```
[ブログHTML]
    ↓
[1. 見出し分割] HTMLを見出し(h1,h2,h3等)で分割してセクション化
    ↓
[2. 台本生成] 各セクションをAIで読み上げ用の文章に変換
    ↓
[3. 音声生成] 台本をTTS(Text-to-Speech) AIで音声ファイルに変換
    ↓
[4. 画像/スライド生成]
    - 画像生成AI で背景画像を生成
    - または スライドエディタで作成したスライドを使用
    - または HTMLをそのまま画像化
    ↓
[5. 字幕データ作成] 音声の長さに合わせて字幕タイミングを計算
    ↓
[6. 動画合成] 音声 + 画像/スライド + 字幕 → MP4に合成
```

---

## 各ステップの詳細

### 1. 見出し分割
- **入力**: ブログHTML
- **出力**: セクション配列 `[{heading, content, level}]`
- **実装**: DOM解析でh1〜h6を検出し分割

### 2. 台本生成 (AI)
- **入力**: 各セクションのコンテンツ
- **出力**: 読み上げ用テキスト（自然な話し言葉に変換）
- **実装**: OpenRouter API (Gemini/DeepSeek等)
- **考慮点**:
  - 専門用語の読み方指定
  - 話し言葉への変換（「である」→「です」等）

### 3. 音声生成 (TTS)
- **入力**: 台本テキスト
- **出力**: 音声ファイル (MP3/WAV) + 長さ(秒)
- **実装**: 下記「TTS API比較」参照

### 4. 画像/スライド生成
- **選択肢A**: 画像生成AI
  - Stable Diffusion / DALL-E / Midjourney API
  - セクション内容からプロンプト生成
- **選択肢B**: スライドエディタ連携
  - 既存のslide-canvasで作成したスライドを使用
  - 各セクションに対応するスライドを選択/自動生成
- **選択肢C**: HTMLそのまま
  - ブログHTMLをスクリーンショットとして使用

### 5. 字幕データ作成
- **入力**: 台本 + 音声の長さ
- **出力**: 字幕データ `[{start, end, text}]`
- **実装**:
  - 文字数ベースで時間を按分
  - または音声認識APIで正確なタイミング取得

### 6. 動画合成
- **入力**: 音声ファイル + 画像/スライド + 字幕データ
- **出力**: MP4ファイル
- **実装**: FFmpeg.wasm（ブラウザ内）またはTauri経由FFmpeg

---

## TTS API 比較（無料・低コスト）

### 推奨: VOICEVOX WEB API (TTS Quest)
- **URL**: `https://api.tts.quest/v3/voicevox/synthesis`
- **料金**: 無料（日割り制限あり、複数キー取得可能）
- **品質**: 高品質（日本語特化）
- **使い方**:
  ```
  curl 'https://api.tts.quest/v3/voicevox/synthesis?speaker=3&text=こんにちは'
  ```
- **APIキー取得**: https://voicevox.su-shiki.com/su-shikiapis/
- **キャラクター**: ずんだもん、四国めたん等 26種類以上

### Eden AI
- **URL**: https://www.edenai.co/feature/text-to-speech-apis
- **料金**: 従量課金（複数プロバイダーを統合）
- **特徴**: Amazon Polly, Google TTS, ElevenLabs等を1つのAPIで利用可能
- **日本語**: 対応（プロバイダーによる）

### その他の選択肢

| サービス | 無料枠 | 品質 | 日本語 | 備考 |
|---------|--------|------|--------|------|
| **VOICEVOX (WEB API)** | 高い日割り制限 | ★★★★★ | ◎ | 推奨 |
| **Kokoro TTS** | OSS (自己ホスト) | ★★★★☆ | ○ | 軽量82Mパラメータ |
| **ElevenLabs** | 10,000文字/月 | ★★★★★ | ○ | 高品質だが枠小 |
| **Web Speech API** | 無制限 | ★★☆☆☆ | ○ | ブラウザ内蔵、低品質 |
| **Google Cloud TTS** | 無料枠あり | ★★★★☆ | ○ | 要クレジットカード登録 |
| **OpenAI TTS** | なし | ★★★★★ | ○ | $15/1M文字 |

### 結論
**VOICEVOX WEB API (TTS Quest)** を第一候補として推奨
- 無料で高品質
- 日本語に特化
- APIキーは簡単に取得可能
- キャラクター豊富で動画に個性が出せる

---

## 動画合成について

### 重要な訂正
**OpenRouterは動画生成に対応していません**
- OpenRouterはLLM（テキスト生成）専用ルーター
- 動画の入力（分析）は可能だが、生成は不可

### 動画合成の実装方法

#### 方法1: FFmpeg.wasm（ブラウザ内）
```javascript
import { FFmpeg } from '@ffmpeg/ffmpeg';

const ffmpeg = new FFmpeg();
await ffmpeg.load();

// 画像 + 音声 → MP4
await ffmpeg.exec([
  '-framerate', '1/5',           // 5秒ごとに画像切り替え
  '-i', 'slide%d.png',           // スライド画像
  '-i', 'audio.mp3',             // 音声
  '-c:v', 'libx264',
  '-pix_fmt', 'yuv420p',
  '-shortest',
  'output.mp4'
]);
```
- **メリット**: ブラウザ完結、インストール不要
- **デメリット**: 処理が遅い（数分かかる）

#### 方法2: Creatomate API（クラウド）
- URL: https://creatomate.com/
- JSONで動画を定義、クラウドでレンダリング
- 有料だが高速・高品質

#### 方法3: Tauri + ローカルFFmpeg
- PCにFFmpegをインストール
- TauriのCommand APIで実行
- **メリット**: 高速
- **デメリット**: ユーザーがFFmpegをインストール必要

### 推奨アプローチ
1. **Phase 1**: FFmpeg.wasm でブラウザ完結
2. **Phase 2**: 必要に応じてTauri + FFmpegに移行

---

## 技術選定まとめ

| 機能 | 採用技術 | 理由 |
|------|----------|------|
| 台本生成 | OpenRouter API | 既存実装を流用 |
| 音声生成 | VOICEVOX WEB API | 無料・高品質・日本語特化 |
| 画像/スライド | 既存スライドエディタ | 実装済み |
| 動画合成 | FFmpeg.wasm | ブラウザ完結 |

---

## UI設計案

```
┌─────────────────────────────────────────────────────────────┐
│ [戻る] 動画生成 - プロジェクト名                    [AI接続中] │
├──────────────┬──────────────────────────────────────────────┤
│ コンテンツ選択 │                                              │
│ ─────────────│                                              │
│ [プロジェクト]│  ┌────────────────────────────────────────┐  │
│ [フォルダHTML]│  │ セクション1: はじめに                   │  │
│              │  │ ┌─────────┐ ┌─────────────────────────┐│  │
│ 選択:        │  │ │ スライド │ │ 台本:                   ││  │
│ [sample.html]│  │ │  画像   │ │ 今回は○○について      ││  │
│              │  │ └─────────┘ │ 解説していきます...     ││  │
│ [分割して読込]│  │             └─────────────────────────┘│  │
│              │  │ [音声生成] [▶再生]                      │  │
│ ─────────────│  └────────────────────────────────────────┘  │
│ TTS設定      │                                              │
│ [VOICEVOX ▼] │  ┌────────────────────────────────────────┐  │
│              │  │ セクション2: 基本概念                   │  │
│ 話者:        │  │ ...                                    │  │
│ [ずんだもん▼]│  └────────────────────────────────────────┘  │
│              │                                              │
│ ─────────────│  ┌────────────────────────────────────────┐  │
│ 画像設定     │  │ [全セクション一括生成]                  │  │
│ [スライド ▼] │  │ [動画プレビュー] [MP4エクスポート]      │  │
│              │  └────────────────────────────────────────┘  │
└──────────────┴──────────────────────────────────────────────┘
```

---

## 実装優先順位

### Phase 1（MVP）
1. [ ] HTML見出し分割機能
2. [ ] 台本生成（AI変換）
3. [ ] 簡易プレビュー（台本表示のみ）

### Phase 2（音声）
4. [ ] VOICEVOX WEB API連携
5. [ ] 音声再生プレビュー

### Phase 3（画像/スライド）
6. [ ] スライドエディタ連携（既存スライドの読み込み）
7. [ ] 各セクションへのスライド割り当て

### Phase 4（動画合成）
8. [ ] 字幕データ生成
9. [ ] FFmpeg.wasmで動画合成
10. [ ] MP4エクスポート

---

## メモ・追加要件

### 2024/11/30 - 初期要件
- ブログHTMLを見出し毎に分割
- 分割したものを台本（音声読み上げ用文章）にAI変換
- AIで音声ファイル生成
- 画像生成AIで画像生成、またはスライドエディタのスライドを使用
- 音声が流れている間に画像/スライドを表示
- 台本の音声と字幕を動画で流す
- 全てをMP4に合成して1つの動画にする

### 2024/11/30 - 技術調査結果
- OpenRouterは動画生成非対応（LLMルーターのみ）
- 音声生成: VOICEVOX WEB API (TTS Quest) を推奨
  - 無料、高品質、日本語特化
- Eden AIは複数TTSプロバイダーの統合API（従量課金）
- 動画合成: FFmpeg.wasm でブラウザ完結可能

---

## 参考リンク

- [VOICEVOX WEB API (TTS Quest)](https://voicevox.su-shiki.com/su-shikiapis/)
- [Eden AI TTS](https://www.edenai.co/feature/text-to-speech-apis)
- [Kokoro TTS (HuggingFace)](https://huggingface.co/hexgrad/Kokoro-82M)
- [FFmpeg.wasm](https://github.com/ffmpegwasm/ffmpeg.wasm)
- [Creatomate](https://creatomate.com/)

